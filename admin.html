<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netim Paneli</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; color: #333; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .container { display: flex; min-height: calc(100vh - 65px); }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 20px 0; }
        .nav-item { padding: 15px 30px; cursor: pointer; transition: background 0.3s; border-left: 3px solid transparent; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: #f8f9fa; }
        .nav-item.active { background: #e3f2fd; border-left-color: #667eea; color: #667eea; font-weight: 600; }
        .main-content { flex: 1; padding: 30px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .page-title { font-size: 28px; color: #333; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .card h3 { color: #333; margin-bottom: 20px; font-size: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .message-success { background: #d4edda; color: #155724; }
        .message-error { background: #f8d7da; color: #721c24; }
        .stats-grid, .report-grid { display: grid; gap: 20px; }
        .stats-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .report-grid { grid-template-columns: 1fr 1fr; }
        .stat-card { text-align: center; }
        .stat-number { font-size: 36px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; }
        .report-list { list-style-type: none; padding: 0; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 5px; border: none; cursor: pointer; margin-right: 5px; }
        .btn-approve { background-color: #10b981; color: white; }
        .btn-reject { background-color: #ef4444; color: white; }
        .btn-edit { background-color: #3b82f6; color: white; }
        .btn-delete { background-color: #990000; color: white; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; white-space: nowrap; }
        .status-beklemede-yonetici { background-color: #f59e0b; }
        .status-beklemede-ik { background-color: #3b82f6; }
        .status-onaylandi { background-color: #10b981; }
        .status-reddedildi, .status-departman-yoneticisi-tarafindan-reddedildi { background-color: #ef4444; }
        .filter-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="panelTitle">Y√∂netim Paneli</h1>
        <div class="user-info">
            <span id="userName"></span>
            <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar"></div>
        <div class="main-content">
            <div id="dashboard" class="page-section">
                <h2 class="page-title">Dashboard</h2>
                <div class="card">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="todaySelections">0</div>
                            <div class="stat-label">Bug√ºnk√º Katƒ±lƒ±m</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Aktif Kullanƒ±cƒ±</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="menu-planning" class="page-section">
                <h2 class="page-title">Men√º Planlama</h2>
                <div class="message" id="menuMessage"></div>
                
                <!-- Excel ƒ∞√ße Aktarma B√∂l√ºm√º -->
                <div class="card" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #cbd5e1;">
                    <h3 style="color: #1e293b; display: flex; align-items: center; gap: 10px;">
                        üìä Excel'den Men√º ƒ∞√ße Aktarma
                    </h3>
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #475569;">
                        <strong>üìù Excel Dosyasƒ± Formatƒ±:</strong><br>
                        ‚Ä¢ S√ºtun A: Tarih (YYYY-MM-DD formatƒ±nda, √∂rn: 2025-08-07)<br>
                        ‚Ä¢ S√ºtun B: √áorba<br>
                        ‚Ä¢ S√ºtun C: Ana Yemek<br>
                        ‚Ä¢ S√ºtun D: Yan Yemek<br>
                        ‚Ä¢ S√ºtun E: Tatlƒ±<br>
                        ‚Ä¢ ƒ∞lk satƒ±r ba≈ülƒ±k olmalƒ±dƒ±r
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="downloadTemplate()" 
                                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; display: flex; align-items: center; gap: 8px;">
                            üìã Excel ≈ûablonu ƒ∞ndir
                        </button>
                        <div style="position: relative; overflow: hidden; display: inline-block;">
                            <button type="button" class="btn" onclick="document.getElementById('excelFile').click()"
                                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; display: flex; align-items: center; gap: 8px;">
                                üìÇ Excel Dosyasƒ± Se√ß ve ƒ∞√ße Aktar
                            </button>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="position: absolute; left: -9999px;" onchange="importExcel()">
                        </div>
                    </div>
                    <div id="importProgress" style="margin-top: 15px; display: none;">
                        <div style="background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #10b981, #059669); height: 8px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="margin-top: 8px; font-size: 14px; color: #6b7280;">ƒ∞≈üleniyor...</div>
                    </div>
                </div>
                
                <!-- Manuel Men√º Ekleme B√∂l√ºm√º -->
                <div class="card">
                    <h3 style="color: #1e293b; display: flex; align-items: center; gap: 10px;">
                        ‚úèÔ∏è Manuel Men√º Ekleme
                    </h3>
                    <form id="menuForm">
                        <div class="form-group"><label for="menuDate">Tarih:</label><input type="date" id="menuDate" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="menuSoup">√áorba:</label><input type="text" id="menuSoup" placeholder="√ñrn: Mercimek √áorbasƒ±"></div>
                            <div class="form-group"><label for="menuMainCourse">Ana Yemek:</label><input type="text" id="menuMainCourse" placeholder="√ñrn: Tavuk Schnitzel" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="menuSideDish">Yan Yemek:</label><input type="text" id="menuSideDish" placeholder="√ñrn: Pilav"></div>
                            <div class="form-group"><label for="menuDessert">Tatlƒ± / Meyve:</label><input type="text" id="menuDessert" placeholder="√ñrn: Muhallebi"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚ûï Men√º Olu≈ütur</button>
                    </form>
                </div>
                
                <!-- Mevcut Men√ºler B√∂l√ºm√º -->
                <div class="card">
                    <h3 style="color: #1e293b; display: flex; align-items: center; gap: 10px;">
                        üìã Mevcut Men√ºler
                    </h3>
                    <div style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="menuStartDate">Ba≈ülangƒ±√ß Tarihi:</label>
                                <input type="date" id="menuStartDate">
                            </div>
                            <div class="form-group">
                                <label for="menuEndDate">Biti≈ü Tarihi:</label>
                                <input type="date" id="menuEndDate">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="button" class="btn btn-primary" onclick="loadExistingMenus()">üîç Men√ºleri Listele</button>
                            </div>
                        </div>
                        
                        <!-- Admin Filtreleme Se√ßenekleri -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">G√∂r√ºn√ºm Filtreleri:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                    <input type="checkbox" id="adminHideWeekends" onchange="loadExistingMenus()">
                                    üèñÔ∏è Hafta sonlarƒ±nƒ± gizle
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                    <input type="checkbox" id="adminHideEmptyDays" onchange="loadExistingMenus()">
                                    üìã Bo≈ü g√ºnleri gizle
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="existingMenusContainer">
                        <p style="text-align: center; color: #6b7280; font-style: italic;">Men√ºleri g√∂r√ºnt√ºlemek i√ßin tarih aralƒ±ƒüƒ± se√ßin ve "Men√ºleri Listele" butonuna tƒ±klayƒ±n.</p>
                    </div>
                </div>
            </div>
            <div id="overtime-requests" class="page-section">
                <h2 class="page-title">Fazla Mesai Talepleri</h2>
                <div class="card" id="filters-card">
                    <h3>Filtrele</h3>
                    <div class="filter-container">
                        <div class="filter-group">
                            <label for="statusFilter">Duruma G√∂re</label>
                            <select id="statusFilter">
                                <option value="Beklemede">T√ºm Bekleyenler</option>
                                <option value="Y√∂netici Onayƒ± Bekliyor">Y√∂netici Onayƒ± Bekliyor</option>
                                <option value="ƒ∞K Onayƒ± Bekliyor">ƒ∞K Onayƒ± Bekliyor</option>
                                <option value="">T√ºm√º</option>
                                <option value="Onaylandƒ±">Onaylandƒ±</option>
                                <option value="Reddedildi">Reddedilenler</option>
                            </select>
                        </div>
                        <div class="filter-group" id="user-filter-group">
                            <label for="userFilter">Personele G√∂re</label>
                            <select id="userFilter"><option value="">T√ºm√º</option></select>
                        </div>
                        <div class="filter-group" id="department-filter-group">
                            <label for="departmentFilter">Departmana G√∂re</label>
                            <select id="departmentFilter"><option value="">T√ºm√º</option></select>
                        </div>
                        <button class="btn btn-primary" onclick="loadOvertimeRequests()">Filtrele</button>
                    </div>
                </div>
                <div class="card">
                    <h3 id="requests-title">Talepler</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Personel</th><th>Departman</th><th>Tarih</th><th>Saatler</th><th>A√ßƒ±klama</th><th>Durum</th><th>ƒ∞≈ülemler</th></tr></thead>
                            <tbody id="overtime-requests-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="reports" class="page-section">
                <h2 class="page-title">Raporlar</h2>
                <div class="card">
                    <h3>Katƒ±lƒ±m Raporlarƒ±</h3>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <input type="date" id="reportDate" class="form-group"><button class="btn btn-primary" onclick="loadAttendanceReport()">Raporu G√∂ster</button>
                    </div>
                    <div id="report-results" style="display: none;">
                        <h4 id="report-title" style="margin-bottom: 15px;"></h4>
                        <div class="report-grid">
                            <div><h5 style="color: #10b981;">‚úîÔ∏è Gelecek Personeller (<span id="attending-count">0</span>)</h5><ul id="attending-list" class="report-list"></ul></div>
                            <div><h5 style="color: #ef4444;">‚ùå Gelmeyecek Personeller (<span id="not-attending-count">0</span>)</h5><ul id="not-attending-list" class="report-list"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="user-management" class="page-section">
                <h2 class="page-title">Kullanƒ±cƒ± Y√∂netimi</h2>
                <div class="message" id="userMessage"></div>
                <div class="card">
                    <button class="btn btn-primary" onclick="openCreateUserModal()">+ Yeni Kullanƒ±cƒ± Ekle</button>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kullanƒ±cƒ± Adƒ±</th>
                                    <th>Email</th>
                                    <th>Departman</th>
                                    <th>Y√∂neticisi</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeUserModal()">&times;</span>
            <h3 id="userModalTitle">Kullanƒ±cƒ± Formu</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="username">Kullanƒ±cƒ± Adƒ±:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="email">E-posta:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group" id="password-group">
                    <label for="password">≈ûifre:</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label for="department">Departman:</label>
                    <input type="text" id="department">
                </div>
                <div class="form-group">
                    <label for="manager">Y√∂netici:</label>
                    <select id="manager"><option value="">Y√∂netici Yok</option></select>
                </div>
                <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let IS_ADMIN = false;
        let IS_MANAGER = false;
        let ALL_USERS_CACHE = [];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            document.getElementById('menuForm')?.addEventListener('submit', handleMenuSubmit);
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            IS_ADMIN = localStorage.getItem('is_admin') === 'true';
            IS_MANAGER = localStorage.getItem('is_manager') === 'true';
            if (!token || (!IS_ADMIN && !IS_MANAGER)) {
                alert('Bu sayfaya eri≈üim yetkiniz yok.');
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userName').textContent = username || 'Kullanƒ±cƒ±';
            setupUI();
        }

        function setupUI() {
            const sidebar = document.getElementById('sidebar');
            let sidebarHTML = '';
            let defaultSection;

            // D√ºzeltme: Tarayƒ±cƒ± hafƒ±zasƒ±ndan son kalƒ±nan sekmeyi oku
            const savedSection = sessionStorage.getItem('lastAdminSection');

            if (IS_ADMIN) {
                document.getElementById('panelTitle').textContent = 'Admin Paneli';
                sidebarHTML = `
                    <div class="nav-item" id="nav-dashboard" onclick="showSection(event, 'dashboard')">üìä Dashboard</div>
                    <div class="nav-item" id="nav-menu-planning" onclick="showSection(event, 'menu-planning')">üìÖ Men√º Planlama</div>
                    <div class="nav-item" id="nav-overtime-requests" onclick="showSection(event, 'overtime-requests')">üïí Fazla Mesai Onaylarƒ±</div>
                    <div class="nav-item" id="nav-reports" onclick="showSection(event, 'reports')">üìã Raporlar</div>
                    <div class="nav-item" id="nav-user-management" onclick="showSection(event, 'user-management')">üë• Kullanƒ±cƒ± Y√∂netimi</div>
                `;
                document.getElementById('user-filter-group').style.display = 'flex';
                document.getElementById('department-filter-group').style.display = 'flex';
                populateFilters();
                
                // D√ºzeltme: Hafƒ±zada sekme varsa onu, yoksa dashboard'u varsayƒ±lan yap
                defaultSection = savedSection || 'dashboard';
                if (!savedSection) { // Sadece ilk giri≈üte filitreyi ayarla
                    document.getElementById('statusFilter').value = "Beklemede";
                }
            } else if (IS_MANAGER) {
                document.getElementById('panelTitle').textContent = 'Y√∂netici Paneli';
                sidebarHTML = `<div class="nav-item" id="nav-overtime-requests" onclick="showSection(event, 'overtime-requests')">üïí Ekip Mesai Talepleri</div>`;
                document.getElementById('user-filter-group').style.display = 'none';
                document.getElementById('department-filter-group').style.display = 'none';
                document.getElementById('requests-title').textContent = 'Ekibimin Mesai Talepleri';
                defaultSection = 'overtime-requests';
                document.getElementById('statusFilter').value = "Y√∂netici Onayƒ± Bekliyor";
            }
            sidebar.innerHTML = sidebarHTML;
            showSection(null, defaultSection);
        }

        function showSection(event, sectionName) {
            // D√ºzeltme: Aktif sekmeyi tarayƒ±cƒ± hafƒ±zasƒ±na kaydet
            sessionStorage.setItem('lastAdminSection', sectionName);

            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                 const nav = document.getElementById(`nav-${sectionName}`);
                 if (nav) nav.classList.add('active');
            }

            if (sectionName === 'dashboard') loadDashboardStats();
            else if (sectionName === 'menu-planning') setDefaultDates();
            else if (sectionName === 'overtime-requests') loadOvertimeRequests();
            else if (sectionName === 'reports') document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            else if (sectionName === 'user-management') loadUsers();
        }

        async function loadOvertimeRequests() {
            const token = localStorage.getItem('token');
            const tableBody = document.getElementById('overtime-requests-table');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Y√ºkleniyor...</td></tr>';
            let url;
            const status = document.getElementById('statusFilter').value;
            if (IS_ADMIN) {
                const userId = document.getElementById('userFilter').value;
                const department = document.getElementById('departmentFilter').value;
                url = new URL(`${API_URL}/api/overtime/all`);
                if (status) url.searchParams.append('status', status);
                if (userId) url.searchParams.append('user_id', userId);
                if (department) url.searchParams.append('department', department);
            } else if (IS_MANAGER) {
                url = new URL(`${API_URL}/api/overtime/manager/all`);
                if (status) url.searchParams.append('status', status);
            } else { return; }
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Talepler y√ºklenemedi');
                let requests = await response.json();
                renderTable(requests);
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: red;">${error.message}</td></tr>`;
            }
        }
        
        async function loadUsers() {
            const token = localStorage.getItem('token');
            const tableBody = document.getElementById('users-table-body');
            const managerSelect = document.getElementById('manager');
            if(!tableBody || !managerSelect) return;
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Y√ºkleniyor...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Kullanƒ±cƒ±lar y√ºklenemedi');
                const users = await response.json();
                ALL_USERS_CACHE = users;
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username} ${user.is_admin ? '(Admin)' : ''}</td>
                        <td>${user.email}</td>
                        <td>${user.department || '-'}</td>
                        <td>${user.manager ? user.manager.username : 'Yok'}</td>
                        <td>
                            <button class="btn-sm btn-edit" onclick='openEditUserModal(${JSON.stringify(user)})'>D√ºzenle</button>
                            <button class="btn-sm btn-delete" onclick="handleDeleteUser(${user.id}, '${user.username}')">Sil</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center;">Hi√ß kullanƒ±cƒ± bulunmuyor.</td></tr>';
                
                managerSelect.innerHTML = '<option value="">Y√∂netici Yok</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} ${user.is_admin ? '(Admin)' : ''}`;
                    managerSelect.appendChild(option);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${error.message}</td></tr>`;
            }
        }

        async function handleDeleteUser(userId, username) {
            if (!confirm(`'${username}' adlƒ± kullanƒ±cƒ±yƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status !== 204) {
                    const error = await response.json().catch(() => null);
                    throw new Error(error ? error.detail : 'Kullanƒ±cƒ± silinemedi. Sunucu hatasƒ±.');
                }
                showMessage('userMessage', `'${username}' adlƒ± kullanƒ±cƒ± ba≈üarƒ±yla silindi.`, 'success');
                loadUsers(); 
            } catch (error) {
                showMessage('userMessage', 'Hata: ' + error.message, 'error');
            }
        }

        const userModal = document.getElementById('userModal');
        const userForm = document.getElementById('userForm');

        function openCreateUserModal() {
            userForm.reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModalTitle').textContent = 'Yeni Kullanƒ±cƒ± Ekle';
            document.getElementById('password-group').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('username').readOnly = false;
            userForm.onsubmit = handleCreateUser;
            userModal.style.display = 'block';
        }

        function openEditUserModal(user) {
            userForm.reset();
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('username').readOnly = true;
            document.getElementById('email').value = user.email;
            document.getElementById('department').value = user.department || '';
            document.getElementById('manager').value = user.manager_id || '';
            document.getElementById('userModalTitle').textContent = 'Kullanƒ±cƒ±yƒ± D√ºzenle';
            document.getElementById('password-group').style.display = 'none';
            document.getElementById('password').required = false;
            userForm.onsubmit = (e) => handleUpdateUser(e, user.id);
            userModal.style.display = 'block';
        }

        function closeUserModal() { userModal.style.display = 'none'; }
        
        async function handleCreateUser(event) {
            event.preventDefault();
            const payload = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                department: document.getElementById('department').value,
                manager_id: document.getElementById('manager').value ? parseInt(document.getElementById('manager').value) : null
            };
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Kullanƒ±cƒ± olu≈üturulamadƒ±'); }
                showMessage('userMessage', 'Kullanƒ±cƒ± ba≈üarƒ±yla olu≈üturuldu!', 'success');
                closeUserModal();
                loadUsers();
                populateFilters(); 
            } catch (error) { showMessage('userMessage', 'Hata: ' + error.message, 'error'); }
        }

        async function handleUpdateUser(event, userId) {
            event.preventDefault();
            const payload = {
                email: document.getElementById('email').value,
                department: document.getElementById('department').value,
                manager_id: document.getElementById('manager').value ? parseInt(document.getElementById('manager').value) : null
            };
             const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Kullanƒ±cƒ± g√ºncellenemedi'); }
                showMessage('userMessage', 'Kullanƒ±cƒ± ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeUserModal();
                loadUsers();
            } catch (error) { showMessage('userMessage', 'Hata: ' + error.message, 'error'); }
        }
        
        window.onclick = function(event) { if (event.target == userModal) { closeUserModal(); } }
        
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message message-${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function renderTable(requests) {
            const tableBody = document.getElementById('overtime-requests-table');
            if (requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">G√∂sterilecek talep bulunmuyor.</td></tr>';
                return;
            }
            tableBody.innerHTML = requests.map(req => {
                let statusClass = '';
                if (req.status === 'Y√∂netici Onayƒ± Bekliyor') statusClass = 'status-beklemede-yonetici';
                else if (req.status === 'ƒ∞K Onayƒ± Bekliyor') statusClass = 'status-beklemede-ik';
                else if (req.status === 'Onaylandƒ±') statusClass = 'status-onaylandi';
                else if (req.status.includes('Reddedildi')) statusClass = 'status-reddedildi';
                let actions = '-';
                if ((IS_MANAGER && !IS_ADMIN) && req.status === 'Y√∂netici Onayƒ± Bekliyor') {
                    actions = `<button class="btn-sm btn-approve" onclick="handleManagerAction(${req.id}, 'approve')">Onayla</button> <button class="btn-sm btn-reject" onclick="handleManagerAction(${req.id}, 'reject')">Reddet</button>`;
                } else if (IS_ADMIN && req.status === 'ƒ∞K Onayƒ± Bekliyor') {
                    actions = `<button class="btn-sm btn-approve" onclick="handleHrAction(${req.id}, 'Onaylandƒ±')">Onayla</button> <button class="btn-sm btn-reject" onclick="handleHrAction(${req.id}, 'Reddedildi')">Reddet</button>`;
                }
                return `<tr><td>${req.user.username}</td><td>${req.department}</td><td>${new Date(req.date).toLocaleDateString('tr-TR')}</td><td>${req.start_time.substring(0,5)} - ${req.end_time.substring(0,5)}</td><td>${req.reason}</td><td><span class="status-badge ${statusClass}">${req.status}</span></td><td>${actions}</td></tr>`;
            }).join('');
        }
        
        function logout(){
            if(confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')){
                sessionStorage.removeItem('lastAdminSection'); // D√ºzeltme: √áƒ±kƒ±≈ü yaparken hafƒ±zayƒ± temizle
                localStorage.clear();
                window.location.href='index.html';
            }
        }
        
        async function handleManagerAction(id,act){if(!confirm(`Bu talebi "${act==='approve'?'onaylamak':'reddetmek'}" istediƒüinize emin misiniz?`))return;const t=localStorage.getItem('token');try{const r=await fetch(`${API_URL}/api/overtime/${id}/manager_action?action=${act}`,{method:'PUT',headers:{'Authorization':`Bearer ${t}`}});if(!r.ok)throw new Error('ƒ∞≈ülem hatasƒ±');showMessage('userMessage', 'Durum g√ºncellendi.', 'success');loadOvertimeRequests();}catch(e){showMessage('userMessage', 'Hata: '+e.message, 'error');}}
        
        async function handleHrAction(id,st){if(!confirm(`Bu talebi "${st}" olarak g√ºncellemek istediƒüinize emin misiniz?`))return;const t=localStorage.getItem('token');try{const r=await fetch(`${API_URL}/api/overtime/${id}/hr_action?status=${st}`,{method:'PUT',headers:{'Authorization':`Bearer ${t}`}});if(!r.ok)throw new Error('Durum g√ºncellenemedi');showMessage('userMessage', 'Durum g√ºncellendi.', 'success');loadOvertimeRequests();}catch(e){showMessage('userMessage', 'Hata: '+e.message, 'error');}}
        
        async function loadDashboardStats(){const token=localStorage.getItem('token');try{const res=await fetch(`${API_URL}/api/stats/dashboard`,{headers:{'Authorization':`Bearer ${token}`}});const data=await res.json();document.getElementById('todaySelections').textContent=data.today_selections;document.getElementById('activeUsers').textContent=data.active_users;}catch(e){console.error(e);}}
        
        async function handleMenuSubmit(e){e.preventDefault();const token=localStorage.getItem('token');const payload={date:document.getElementById('menuDate').value,meal_type:'√ñƒüle Yemeƒüi',menu_items:{Corbasi:document.getElementById('menuSoup').value,Ana_Yemek:document.getElementById('menuMainCourse').value,Yan_Yemek:document.getElementById('menuSideDish').value,Tatli:document.getElementById('menuDessert').value,}};try{const res=await fetch(`${API_URL}/api/menu`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok){const err=await res.json();throw new Error(err.detail);}showMessage('menuMessage','Men√º ba≈üarƒ±yla eklendi!','success');e.target.reset();}catch(err){showMessage('menuMessage','Hata: '+err.message,'error');}}
        
        async function loadAttendanceReport(){const token=localStorage.getItem('token');const date=document.getElementById('reportDate').value;try{const res=await fetch(`${API_URL}/api/attendance/${date}`,{headers:{'Authorization':`Bearer ${token}`}});if(!res.ok)throw new Error('Rapor alƒ±namadƒ±');const data=await res.json();const attendingList=document.getElementById('attending-list');const notAttendingList=document.getElementById('not-attending-list');attendingList.innerHTML='';notAttendingList.innerHTML='';let attendingCount=0;let notAttendingCount=0;data.forEach(item=>{if(item.will_attend){attendingList.innerHTML+=`<li>${item.user.username} (${item.user.department||'N/A'})</li>`;attendingCount++;}else{notAttendingList.innerHTML+=`<li>${item.user.username} (${item.user.department||'N/A'})</li>`;notAttendingCount++;}});document.getElementById('attending-count').textContent=attendingCount;document.getElementById('not-attending-count').textContent=notAttendingCount;document.getElementById('report-title').textContent=`${new Date(date).toLocaleDateString('tr-TR')} Tarihli Rapor`;document.getElementById('report-results').style.display='block';}catch(err){alert('Hata: '+err.message);}}
        
        function setDefaultDates(){
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('menuDate').value = today;
            
            // Mevcut men√ºler i√ßin varsayƒ±lan tarih aralƒ±ƒüƒ± (bug√ºnden itibaren 30 g√ºn)
            document.getElementById('menuStartDate').value = today;
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            document.getElementById('menuEndDate').value = endDate.toISOString().split('T')[0];
        }
        
        // Mevcut men√ºleri y√ºkleme fonksiyonu
        async function loadExistingMenus() {
            const startDate = document.getElementById('menuStartDate').value;
            const endDate = document.getElementById('menuEndDate').value;
            
            if (!startDate || !endDate) {
                alert('L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßin.');
                return;
            }
            
            // Loading g√∂stergesi
            const container = document.getElementById('existingMenusContainer');
            container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">‚è≥ Men√ºler y√ºkleniyor...</p>';
            
            try {
                const token = localStorage.getItem('token');
                // Cache'i bypass etmek i√ßin timestamp ekle
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_URL}/api/menus?start_date=${startDate}&end_date=${endDate}&_t=${timestamp}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) throw new Error('Men√ºler y√ºklenemedi');
                
                const menus = await response.json();
                console.log('Y√ºklenen men√ºler:', menus); // Debug i√ßin
                
                // Filtreleme uygula
                const hideWeekends = document.getElementById('adminHideWeekends').checked;
                const hideEmptyDays = document.getElementById('adminHideEmptyDays').checked;
                
                const filteredMenus = menus.filter(menu => {
                    const menuDate = new Date(menu.date);
                    const dayOfWeek = menuDate.getDay();
                    
                    // Hafta sonu filtresi
                    if (hideWeekends && (dayOfWeek === 0 || dayOfWeek === 6)) {
                        return false;
                    }
                    
                    // Bo≈ü g√ºn filtresi
                    if (hideEmptyDays) {
                        const items = menu.menu_items || {};
                        const isEmpty = !items.Corbasi && !items.Ana_Yemek && !items.Yan_Yemek && !items.Tatli;
                        if (isEmpty) return false;
                    }
                    
                    return true;
                });
                
                renderExistingMenus(filteredMenus);
            } catch (error) {
                container.innerHTML = `<p style="text-align: center; color: #ef4444;">Hata: ${error.message}</p>`;
                showMessage('menuMessage', 'Hata: ' + error.message, 'error');
            }
        }
        
        // Mevcut men√ºleri render etme fonksiyonu
        function renderExistingMenus(menus) {
            const container = document.getElementById('existingMenusContainer');
            
            if (menus.length === 0) {
                // Filtre uygulanmƒ±≈ü mƒ± kontrol et
                const hideWeekends = document.getElementById('adminHideWeekends').checked;
                const hideEmptyDays = document.getElementById('adminHideEmptyDays').checked;
                
                if (hideWeekends || hideEmptyDays) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">Filtreleme sonucunda g√∂sterilecek men√º bulunamadƒ±. Filtre se√ßeneklerini kontrol edin.</p>';
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">Se√ßilen tarih aralƒ±ƒüƒ±nda men√º bulunamadƒ±.</p>';
                }
                return;
            }
            
            // Debug i√ßin men√º objelerini logla
            console.log('Men√º objeleri:', menus);
            
            const menuHtml = menus.map(menu => {
                // Menu ID kontrol√º
                const menuId = menu.id;
                if (!menuId) {
                    console.error('Men√º ID bulunamadƒ±:', menu);
                    return '';
                }
                
                return `
                    <div id="menu-${menuId}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9fafb;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #374151;">
                                üìÖ ${new Date(menu.date).toLocaleDateString('tr-TR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                                <small style="color: #6b7280; font-weight: normal;"> (ID: ${menuId})</small>
                            </h4>
                            <button id="delete-btn-${menuId}" class="btn-sm btn-delete" onclick="deleteMenu(${menuId}, '${menu.date}')" 
                                    style="margin-left: auto;">
                                üóëÔ∏è Sil
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                            <div><strong>üç≤ √áorba:</strong> ${menu.menu_items?.Corbasi || '-'}</div>
                            <div><strong>üçñ Ana Yemek:</strong> ${menu.menu_items?.Ana_Yemek || '-'}</div>
                            <div><strong>üçö Yan Yemek:</strong> ${menu.menu_items?.Yan_Yemek || '-'}</div>
                            <div><strong>üç∞ Tatlƒ±:</strong> ${menu.menu_items?.Tatli || '-'}</div>
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join('');
            
            container.innerHTML = menuHtml;
            console.log('Render edilen men√º sayƒ±sƒ±:', menus.length); // Debug i√ßin
        }
        
        // Men√º silme fonksiyonu
        async function deleteMenu(menuId, menuDate) {
            console.log('deleteMenu √ßaƒürƒ±ldƒ±:', { menuId, menuDate }); // Debug
            
            // Parametreleri kontrol et
            if (!menuId || menuId === 'undefined') {
                console.error('Ge√ßersiz men√º ID:', menuId);
                showMessage('menuMessage', 'Hata: Ge√ßersiz men√º ID', 'error');
                return;
            }
            
            if (!confirm(`${new Date(menuDate).toLocaleDateString('tr-TR')} tarihli men√ºy√º silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz ve ilgili katƒ±lƒ±m kayƒ±tlarƒ± da silinecektir.`)) {
                return;
            }
            
            // Silme i≈ülemi sƒ±rasƒ±nda butonu deaktive et
            const deleteButton = document.getElementById(`delete-btn-${menuId}`);
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.textContent = '‚è≥ Siliniyor...';
            }
            
            try {
                const token = localStorage.getItem('token');
                console.log('Silme isteƒüi g√∂nderiliyor:', `${API_URL}/api/menu/${menuId}`); // Debug
                
                const response = await fetch(`${API_URL}/api/menu/${menuId}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('Silme response:', response.status, response.statusText); // Debug
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Silme hatasƒ±:', errorData); // Debug
                    throw new Error(errorData.detail || 'Men√º silinemedi');
                }
                
                const result = await response.json();
                console.log('Silme ba≈üarƒ±lƒ±:', result); // Debug
                
                showMessage('menuMessage', 
                    `Men√º ba≈üarƒ±yla silindi!\n\nSilinen men√º ID: ${result.deleted_menu_id}\nSilinen katƒ±lƒ±m kaydƒ±: ${result.deleted_attendance_count} adet`, 
                    'success'
                );
                
                // Kƒ±sa bir bekleyip listeyi yenile
                setTimeout(() => {
                    loadExistingMenus();
                }, 500);
                
            } catch (error) {
                console.error('Silme hatasƒ±:', error);
                showMessage('menuMessage', 'Hata: ' + error.message, 'error');
                
                // Hata durumunda butonu tekrar aktif et
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.textContent = 'üóëÔ∏è Sil';
                }
            }
        }
        
        // Excel ƒ∞≈üleme Fonksiyonlarƒ±
        async function downloadTemplate() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/menu/excel-template`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('≈ûablon indirilemedi');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'menu_template.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showMessage('menuMessage', 'üìã Excel ≈üablonu ba≈üarƒ±yla indirildi!', 'success');
            } catch (error) {
                showMessage('menuMessage', 'Hata: ' + error.message, 'error');
            }
        }
        
        async function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('menuMessage', 'L√ºtfen bir dosya se√ßin', 'error');
                return;
            }
            
            // Progress g√∂ster
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '20%';
            document.getElementById('progressText').textContent = 'Dosya y√ºkleniyor...';
            
            const token = localStorage.getItem('token');
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                document.getElementById('progressBar').style.width = '50%';
                document.getElementById('progressText').textContent = 'Veriler i≈üleniyor...';
                
                const response = await fetch(`${API_URL}/api/menu/import-excel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                document.getElementById('progressBar').style.width = '80%';
                document.getElementById('progressText').textContent = 'Sonu√ßlar kontrol ediliyor...';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Y√ºkleme ba≈üarƒ±sƒ±z');
                }
                
                const result = await response.json();
                
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = 'Tamamlandƒ±!';
                
                // Sonu√ß mesajƒ±nƒ± olu≈ütur
                let message = `‚úÖ ƒ∞√ße aktarma tamamlandƒ±!\\n\\n`;
                message += `üì• Yeni eklenen: ${result.imported_count} men√º\\n`;
                message += `üîÑ G√ºncellenen: ${result.updated_count} men√º`;
                
                if (result.error_count > 0) {
                    message += `\\n\\n‚ö†Ô∏è Hatalar (${result.error_count}):\\n`;
                    message += result.errors.slice(0, 5).join('\\n');
                    if (result.errors.length > 5) {
                        message += `\\n... ve ${result.errors.length - 5} hata daha`;
                    }
                }
                
                // Ba≈üarƒ±lƒ± mesaj g√∂ster
                showMessage('menuMessage', message.replace(/\\n/g, '<br>'), 'success');
                
                // Progress gizle
                setTimeout(() => {
                    document.getElementById('importProgress').style.display = 'none';
                    document.getElementById('progressBar').style.width = '0%';
                }, 2000);
                
                // Dosya input'unu temizle
                fileInput.value = '';
                
            } catch (error) {
                document.getElementById('importProgress').style.display = 'none';
                showMessage('menuMessage', 'Hata: ' + error.message, 'error');
                fileInput.value = '';
            }
        }
        
        async function populateFilters() {
            const token = localStorage.getItem('token');
            const userFilter = document.getElementById('userFilter');
            const departmentFilter = document.getElementById('departmentFilter');
            if (userFilter.options.length > 1 && ALL_USERS_CACHE.length > 0) return;
            try {
                const response = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) return;
                const users = await response.json();
                ALL_USERS_CACHE = users;
                const departments = new Set();
                userFilter.innerHTML = '<option value="">T√ºm√º</option>';
                users.forEach(user => {
                    const userOption = document.createElement('option');
                    userOption.value = user.id;
                    userOption.textContent = user.username;
                    userFilter.appendChild(userOption);
                    if (user.department) departments.add(user.department);
                });
                departmentFilter.innerHTML = '<option value="">T√ºm√º</option>';
                departments.forEach(dep => {
                    const depOption = document.createElement('option');
                    depOption.value = dep;
                    depOption.textContent = dep;
                    departmentFilter.appendChild(depOption);
                });
            } catch (error) { console.error("Filtreler i√ßin veri y√ºklenemedi:", error); }
        }
    </script>
</body>
</html>
