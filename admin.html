<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; color: #333; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .container { display: flex; min-height: calc(100vh - 65px); }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 20px 0; }
        .nav-item { padding: 15px 30px; cursor: pointer; transition: background 0.3s; border-left: 3px solid transparent; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: #f8f9fa; }
        .nav-item.active { background: #e3f2fd; border-left-color: #667eea; color: #667eea; font-weight: 600; }
        .main-content { flex: 1; padding: 30px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .page-title { font-size: 28px; color: #333; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .card h3 { color: #333; margin-bottom: 20px; font-size: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .message-success { background: #d4edda; color: #155724; }
        .message-error { background: #f8d7da; color: #721c24; }
        .stats-grid, .report-grid { display: grid; gap: 20px; }
        .stats-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .report-grid { grid-template-columns: 1fr 1fr; }
        .stat-card { text-align: center; }
        .stat-number { font-size: 36px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; }
        .report-list { list-style-type: none; padding: 0; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 5px; border: none; cursor: pointer; margin-right: 5px; }
        .btn-approve { background-color: #10b981; color: white; }
        .btn-reject { background-color: #ef4444; color: white; }
        .btn-edit { background-color: #3b82f6; color: white; }
        .btn-delete { background-color: #990000; color: white; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; white-space: nowrap; }
        .status-beklemede-yonetici { background-color: #f59e0b; }
        .status-beklemede-ik { background-color: #3b82f6; }
        .status-onaylandi { background-color: #10b981; }
        .status-reddedildi, .status-yonetici-tarafindan-reddedildi { background-color: #ef4444; }
        .filter-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="panelTitle">Yönetim Paneli</h1>
        <div class="user-info">
            <span id="userName"></span>
            <button class="logout-btn" onclick="logout()">Çıkış</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar"></div>
        <div class="main-content">
            <div id="dashboard" class="page-section">
                <h2 class="page-title">Dashboard</h2>
                <div class="card">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="todaySelections">0</div>
                            <div class="stat-label">Bugünkü Katılım</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Aktif Kullanıcı</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="menu-planning" class="page-section">
                <h2 class="page-title">Menü Planlama</h2>
                <div class="message" id="menuMessage"></div>
                <div class="card">
                    <h3>Yeni Menü Oluştur</h3>
                    <form id="menuForm">
                        <div class="form-group"><label for="menuDate">Tarih:</label><input type="date" id="menuDate" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="menuSoup">Çorba:</label><input type="text" id="menuSoup"></div>
                            <div class="form-group"><label for="menuMainCourse">Ana Yemek:</label><input type="text" id="menuMainCourse" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="menuSideDish">Yan Yemek:</label><input type="text" id="menuSideDish"></div>
                            <div class="form-group"><label for="menuDessert">Tatlı / Meyve:</label><input type="text" id="menuDessert"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">📅 Menü Oluştur</button>
                    </form>
                </div>
            </div>
            <div id="overtime-requests" class="page-section">
                <h2 class="page-title">Fazla Mesai Talepleri</h2>
                <div class="card" id="filters-card">
                    <h3>Filtrele</h3>
                    <div class="filter-container">
                        <div class="filter-group">
                            <label for="statusFilter">Duruma Göre</label>
                            <select id="statusFilter">
                                <option value="Beklemede">Tüm Bekleyenler</option>
                                <option value="Yönetici Onayı Bekliyor">Yönetici Onayı Bekliyor</option>
                                <option value="İK Onayı Bekliyor">İK Onayı Bekliyor</option>
                                <option value="">Tümü</option>
                                <option value="Onaylandı">Onaylandı</option>
                                <option value="Reddedildi">Reddedilenler</option>
                            </select>
                        </div>
                        <div class="filter-group" id="user-filter-group">
                            <label for="userFilter">Personele Göre</label>
                            <select id="userFilter"><option value="">Tümü</option></select>
                        </div>
                        <div class="filter-group" id="department-filter-group">
                            <label for="departmentFilter">Departmana Göre</label>
                            <select id="departmentFilter"><option value="">Tümü</option></select>
                        </div>
                        <button class="btn btn-primary" onclick="loadOvertimeRequests()">Filtrele</button>
                    </div>
                </div>
                <div class="card">
                    <h3 id="requests-title">Talepler</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Personel</th><th>Departman</th><th>Tarih</th><th>Saatler</th><th>Açıklama</th><th>Durum</th><th>İşlemler</th></tr></thead>
                            <tbody id="overtime-requests-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="reports" class="page-section">
                <h2 class="page-title">Raporlar</h2>
                <div class="card">
                    <h3>Katılım Raporları</h3>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <input type="date" id="reportDate" class="form-group"><button class="btn btn-primary" onclick="loadAttendanceReport()">Raporu Göster</button>
                    </div>
                    <div id="report-results" style="display: none;">
                        <h4 id="report-title" style="margin-bottom: 15px;"></h4>
                        <div class="report-grid">
                            <div><h5 style="color: #10b981;">✔️ Gelecek Personeller (<span id="attending-count">0</span>)</h5><ul id="attending-list" class="report-list"></ul></div>
                            <div><h5 style="color: #ef4444;">❌ Gelmeyecek Personeller (<span id="not-attending-count">0</span>)</h5><ul id="not-attending-list" class="report-list"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="user-management" class="page-section">
                <h2 class="page-title">Kullanıcı Yönetimi</h2>
                <div class="message" id="userMessage"></div>
                <div class="card">
                    <button class="btn btn-primary" onclick="openCreateUserModal()">+ Yeni Kullanıcı Ekle</button>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kullanıcı Adı</th>
                                    <th>Email</th>
                                    <th>Departman</th>
                                    <th>Yöneticisi</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeUserModal()">&times;</span>
            <h3 id="userModalTitle">Kullanıcı Formu</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="username">Kullanıcı Adı:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="email">E-posta:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group" id="password-group">
                    <label for="password">Şifre:</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label for="department">Departman:</label>
                    <input type="text" id="department">
                </div>
                <div class="form-group">
                    <label for="manager">Yönetici:</label>
                    <select id="manager"><option value="">Yönetici Yok</option></select>
                </div>
                <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let IS_ADMIN = false;
        let IS_MANAGER = false;
        let ALL_USERS_CACHE = [];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            document.getElementById('menuForm')?.addEventListener('submit', handleMenuSubmit);
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            IS_ADMIN = localStorage.getItem('is_admin') === 'true';
            IS_MANAGER = localStorage.getItem('is_manager') === 'true';
            if (!token || (!IS_ADMIN && !IS_MANAGER)) {
                alert('Bu sayfaya erişim yetkiniz yok.');
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userName').textContent = username || 'Kullanıcı';
            setupUI();
        }

        function setupUI() {
            const sidebar = document.getElementById('sidebar');
            let sidebarHTML = '';
            let defaultSection;

            // Düzeltme: Tarayıcı hafızasından son kalınan sekmeyi oku
            const savedSection = sessionStorage.getItem('lastAdminSection');

            if (IS_ADMIN) {
                document.getElementById('panelTitle').textContent = 'Admin Paneli';
                sidebarHTML = `
                    <div class="nav-item" id="nav-dashboard" onclick="showSection(event, 'dashboard')">📊 Dashboard</div>
                    <div class="nav-item" id="nav-menu-planning" onclick="showSection(event, 'menu-planning')">📅 Menü Planlama</div>
                    <div class="nav-item" id="nav-overtime-requests" onclick="showSection(event, 'overtime-requests')">🕒 Fazla Mesai Onayları</div>
                    <div class="nav-item" id="nav-reports" onclick="showSection(event, 'reports')">📋 Raporlar</div>
                    <div class="nav-item" id="nav-user-management" onclick="showSection(event, 'user-management')">👥 Kullanıcı Yönetimi</div>
                `;
                document.getElementById('user-filter-group').style.display = 'flex';
                document.getElementById('department-filter-group').style.display = 'flex';
                populateFilters();
                
                // Düzeltme: Hafızada sekme varsa onu, yoksa dashboard'u varsayılan yap
                defaultSection = savedSection || 'dashboard';
                if (!savedSection) { // Sadece ilk girişte filitreyi ayarla
                    document.getElementById('statusFilter').value = "Beklemede";
                }
            } else if (IS_MANAGER) {
                document.getElementById('panelTitle').textContent = 'Yönetici Paneli';
                sidebarHTML = `<div class="nav-item" id="nav-overtime-requests" onclick="showSection(event, 'overtime-requests')">🕒 Ekip Mesai Talepleri</div>`;
                document.getElementById('user-filter-group').style.display = 'none';
                document.getElementById('department-filter-group').style.display = 'none';
                document.getElementById('requests-title').textContent = 'Ekibimin Mesai Talepleri';
                defaultSection = 'overtime-requests';
                document.getElementById('statusFilter').value = "Yönetici Onayı Bekliyor";
            }
            sidebar.innerHTML = sidebarHTML;
            showSection(null, defaultSection);
        }

        function showSection(event, sectionName) {
            // Düzeltme: Aktif sekmeyi tarayıcı hafızasına kaydet
            sessionStorage.setItem('lastAdminSection', sectionName);

            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                 const nav = document.getElementById(`nav-${sectionName}`);
                 if (nav) nav.classList.add('active');
            }

            if (sectionName === 'dashboard') loadDashboardStats();
            else if (sectionName === 'menu-planning') setDefaultDates();
            else if (sectionName === 'overtime-requests') loadOvertimeRequests();
            else if (sectionName === 'reports') document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            else if (sectionName === 'user-management') loadUsers();
        }

        async function loadOvertimeRequests() {
            const token = localStorage.getItem('token');
            const tableBody = document.getElementById('overtime-requests-table');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yükleniyor...</td></tr>';
            let url;
            const status = document.getElementById('statusFilter').value;
            if (IS_ADMIN) {
                const userId = document.getElementById('userFilter').value;
                const department = document.getElementById('departmentFilter').value;
                url = new URL(`${API_URL}/api/overtime/all`);
                if (status) url.searchParams.append('status', status);
                if (userId) url.searchParams.append('user_id', userId);
                if (department) url.searchParams.append('department', department);
            } else if (IS_MANAGER) {
                url = new URL(`${API_URL}/api/overtime/manager/all`);
                if (status) url.searchParams.append('status', status);
            } else { return; }
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Talepler yüklenemedi');
                let requests = await response.json();
                renderTable(requests);
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: red;">${error.message}</td></tr>`;
            }
        }
        
        async function loadUsers() {
            const token = localStorage.getItem('token');
            const tableBody = document.getElementById('users-table-body');
            const managerSelect = document.getElementById('manager');
            if(!tableBody || !managerSelect) return;
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Yükleniyor...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Kullanıcılar yüklenemedi');
                const users = await response.json();
                ALL_USERS_CACHE = users;
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username} ${user.is_admin ? '(Admin)' : ''}</td>
                        <td>${user.email}</td>
                        <td>${user.department || '-'}</td>
                        <td>${user.manager ? user.manager.username : 'Yok'}</td>
                        <td>
                            <button class="btn-sm btn-edit" onclick='openEditUserModal(${JSON.stringify(user)})'>Düzenle</button>
                            <button class="btn-sm btn-delete" onclick="handleDeleteUser(${user.id}, '${user.username}')">Sil</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center;">Hiç kullanıcı bulunmuyor.</td></tr>';
                
                managerSelect.innerHTML = '<option value="">Yönetici Yok</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} ${user.is_admin ? '(Admin)' : ''}`;
                    managerSelect.appendChild(option);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${error.message}</td></tr>`;
            }
        }

        async function handleDeleteUser(userId, username) {
            if (!confirm(`'${username}' adlı kullanıcıyı kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status !== 204) {
                    const error = await response.json().catch(() => null);
                    throw new Error(error ? error.detail : 'Kullanıcı silinemedi. Sunucu hatası.');
                }
                showMessage('userMessage', `'${username}' adlı kullanıcı başarıyla silindi.`, 'success');
                loadUsers(); 
            } catch (error) {
                showMessage('userMessage', 'Hata: ' + error.message, 'error');
            }
        }

        const userModal = document.getElementById('userModal');
        const userForm = document.getElementById('userForm');

        function openCreateUserModal() {
            userForm.reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModalTitle').textContent = 'Yeni Kullanıcı Ekle';
            document.getElementById('password-group').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('username').readOnly = false;
            userForm.onsubmit = handleCreateUser;
            userModal.style.display = 'block';
        }

        function openEditUserModal(user) {
            userForm.reset();
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('username').readOnly = true;
            document.getElementById('email').value = user.email;
            document.getElementById('department').value = user.department || '';
            document.getElementById('manager').value = user.manager_id || '';
            document.getElementById('userModalTitle').textContent = 'Kullanıcıyı Düzenle';
            document.getElementById('password-group').style.display = 'none';
            document.getElementById('password').required = false;
            userForm.onsubmit = (e) => handleUpdateUser(e, user.id);
            userModal.style.display = 'block';
        }

        function closeUserModal() { userModal.style.display = 'none'; }
        
        async function handleCreateUser(event) {
            event.preventDefault();
            const payload = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                department: document.getElementById('department').value,
                manager_id: document.getElementById('manager').value ? parseInt(document.getElementById('manager').value) : null
            };
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Kullanıcı oluşturulamadı'); }
                showMessage('userMessage', 'Kullanıcı başarıyla oluşturuldu!', 'success');
                closeUserModal();
                loadUsers();
                populateFilters(); 
            } catch (error) { showMessage('userMessage', 'Hata: ' + error.message, 'error'); }
        }

        async function handleUpdateUser(event, userId) {
            event.preventDefault();
            const payload = {
                email: document.getElementById('email').value,
                department: document.getElementById('department').value,
                manager_id: document.getElementById('manager').value ? parseInt(document.getElementById('manager').value) : null
            };
             const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Kullanıcı güncellenemedi'); }
                showMessage('userMessage', 'Kullanıcı başarıyla güncellendi!', 'success');
                closeUserModal();
                loadUsers();
            } catch (error) { showMessage('userMessage', 'Hata: ' + error.message, 'error'); }
        }
        
        window.onclick = function(event) { if (event.target == userModal) { closeUserModal(); } }
        
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message message-${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function renderTable(requests) {
            const tableBody = document.getElementById('overtime-requests-table');
            if (requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Gösterilecek talep bulunmuyor.</td></tr>';
                return;
            }
            tableBody.innerHTML = requests.map(req => {
                let statusClass = '';
                if (req.status === 'Yönetici Onayı Bekliyor') statusClass = 'status-beklemede-yonetici';
                else if (req.status === 'İK Onayı Bekliyor') statusClass = 'status-beklemede-ik';
                else if (req.status === 'Onaylandı') statusClass = 'status-onaylandi';
                else if (req.status.includes('Reddedildi')) statusClass = 'status-reddedildi';
                let actions = '-';
                if ((IS_MANAGER && !IS_ADMIN) && req.status === 'Yönetici Onayı Bekliyor') {
                    actions = `<button class="btn-sm btn-approve" onclick="handleManagerAction(${req.id}, 'approve')">Onayla</button> <button class="btn-sm btn-reject" onclick="handleManagerAction(${req.id}, 'reject')">Reddet</button>`;
                } else if (IS_ADMIN && req.status === 'İK Onayı Bekliyor') {
                    actions = `<button class="btn-sm btn-approve" onclick="handleHrAction(${req.id}, 'Onaylandı')">Onayla</button> <button class="btn-sm btn-reject" onclick="handleHrAction(${req.id}, 'Reddedildi')">Reddet</button>`;
                }
                return `<tr><td>${req.user.username}</td><td>${req.department}</td><td>${new Date(req.date).toLocaleDateString('tr-TR')}</td><td>${req.start_time.substring(0,5)} - ${req.end_time.substring(0,5)}</td><td>${req.reason}</td><td><span class="status-badge ${statusClass}">${req.status}</span></td><td>${actions}</td></tr>`;
            }).join('');
        }
        
        function logout(){
            if(confirm('Çıkış yapmak istediğinizden emin misiniz?')){
                sessionStorage.removeItem('lastAdminSection'); // Düzeltme: Çıkış yaparken hafızayı temizle
                localStorage.clear();
                window.location.href='index.html';
            }
        }
        
        async function handleManagerAction(id,act){if(!confirm(`Bu talebi "${act==='approve'?'onaylamak':'reddetmek'}" istediğinize emin misiniz?`))return;const t=localStorage.getItem('token');try{const r=await fetch(`${API_URL}/api/overtime/${id}/manager_action?action=${act}`,{method:'PUT',headers:{'Authorization':`Bearer ${t}`}});if(!r.ok)throw new Error('İşlem hatası');showMessage('userMessage', 'Durum güncellendi.', 'success');loadOvertimeRequests();}catch(e){showMessage('userMessage', 'Hata: '+e.message, 'error');}}
        
        async function handleHrAction(id,st){if(!confirm(`Bu talebi "${st}" olarak güncellemek istediğinize emin misiniz?`))return;const t=localStorage.getItem('token');try{const r=await fetch(`${API_URL}/api/overtime/${id}/hr_action?status=${st}`,{method:'PUT',headers:{'Authorization':`Bearer ${t}`}});if(!r.ok)throw new Error('Durum güncellenemedi');showMessage('userMessage', 'Durum güncellendi.', 'success');loadOvertimeRequests();}catch(e){showMessage('userMessage', 'Hata: '+e.message, 'error');}}
        
        async function loadDashboardStats(){const token=localStorage.getItem('token');try{const res=await fetch(`${API_URL}/api/stats/dashboard`,{headers:{'Authorization':`Bearer ${token}`}});const data=await res.json();document.getElementById('todaySelections').textContent=data.today_selections;document.getElementById('activeUsers').textContent=data.active_users;}catch(e){console.error(e);}}
        
        async function handleMenuSubmit(e){e.preventDefault();const token=localStorage.getItem('token');const payload={date:document.getElementById('menuDate').value,meal_type:'Öğle Yemeği',menu_items:{Corbasi:document.getElementById('menuSoup').value,Ana_Yemek:document.getElementById('menuMainCourse').value,Yan_Yemek:document.getElementById('menuSideDish').value,Tatli:document.getElementById('menuDessert').value,}};try{const res=await fetch(`${API_URL}/api/menu`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok){const err=await res.json();throw new Error(err.detail);}showMessage('menuMessage','Menü başarıyla eklendi!','success');e.target.reset();}catch(err){showMessage('menuMessage','Hata: '+err.message,'error');}}
        
        async function loadAttendanceReport(){const token=localStorage.getItem('token');const date=document.getElementById('reportDate').value;try{const res=await fetch(`${API_URL}/api/attendance/${date}`,{headers:{'Authorization':`Bearer ${token}`}});if(!res.ok)throw new Error('Rapor alınamadı');const data=await res.json();const attendingList=document.getElementById('attending-list');const notAttendingList=document.getElementById('not-attending-list');attendingList.innerHTML='';notAttendingList.innerHTML='';let attendingCount=0;let notAttendingCount=0;data.forEach(item=>{if(item.will_attend){attendingList.innerHTML+=`<li>${item.user.username} (${item.user.department||'N/A'})</li>`;attendingCount++;}else{notAttendingList.innerHTML+=`<li>${item.user.username} (${item.user.department||'N/A'})</li>`;notAttendingCount++;}});document.getElementById('attending-count').textContent=attendingCount;document.getElementById('not-attending-count').textContent=notAttendingCount;document.getElementById('report-title').textContent=`${new Date(date).toLocaleDateString('tr-TR')} Tarihli Rapor`;document.getElementById('report-results').style.display='block';}catch(err){alert('Hata: '+err.message);}}
        
        function setDefaultDates(){document.getElementById('menuDate').value=new Date().toISOString().split('T')[0];}
        
        async function populateFilters() {
            const token = localStorage.getItem('token');
            const userFilter = document.getElementById('userFilter');
            const departmentFilter = document.getElementById('departmentFilter');
            if (userFilter.options.length > 1 && ALL_USERS_CACHE.length > 0) return;
            try {
                const response = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) return;
                const users = await response.json();
                ALL_USERS_CACHE = users;
                const departments = new Set();
                userFilter.innerHTML = '<option value="">Tümü</option>';
                users.forEach(user => {
                    const userOption = document.createElement('option');
                    userOption.value = user.id;
                    userOption.textContent = user.username;
                    userFilter.appendChild(userOption);
                    if (user.department) departments.add(user.department);
                });
                departmentFilter.innerHTML = '<option value="">Tümü</option>';
                departments.forEach(dep => {
                    const depOption = document.createElement('option');
                    depOption.value = dep;
                    depOption.textContent = dep;
                    departmentFilter.appendChild(depOption);
                });
            } catch (error) { console.error("Filtreler için veri yüklenemedi:", error); }
        }
    </script>
</body>
</html>