<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yemekhane Sistemi - KullanÄ±cÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .selected-yes { border-color: #10b981; background-color: #ecfdf5; }
        .selected-no { border-color: #ef4444; background-color: #fef2f2; }
        .today-highlight { box-shadow: 0 0 0 2px #3b82f6; }
        .main-tab { background-color: white; color: #374151; border-color: transparent; transition: all 0.2s ease-in-out; }
        .main-tab.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .view-btn { background-color: white; color: #4b5563; }
        .view-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">ğŸ½ï¸</span>
                    <h1 class="text-xl font-semibold text-gray-900">KullanÄ±cÄ± Paneli</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600" id="userName"></span>
                    <button class="text-indigo-600 hover:text-indigo-800" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="showPage('yemekhane')" id="yemekhane-tab" class="main-tab whitespace-nowrap py-3 px-6 border-b-2 font-medium text-sm rounded-t-lg">Yemekhane MenÃ¼sÃ¼</button>
                <button onclick="showPage('mesai')" id="mesai-tab" class="main-tab whitespace-nowrap py-3 px-6 border-b-2 font-medium text-sm rounded-t-lg">Fazla Mesai Taleplerim</button>
            </nav>
        </div>

        <div id="yemekhane-page" class="page-content">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex gap-2">
                    <button onclick="setActiveView('daily')" id="daily-btn" class="view-btn px-4 py-2 rounded-lg font-medium">GÃ¼nlÃ¼k</button>
                    <button onclick="setActiveView('weekly')" id="weekly-btn" class="view-btn px-4 py-2 rounded-lg font-medium">HaftalÄ±k</button>
                    <button onclick="setActiveView('monthly')" id="monthly-btn" class="view-btn px-4 py-2 rounded-lg font-medium">AylÄ±k</button>
                </div>
                <div class="bg-blue-100 px-4 py-2 rounded-lg">
                    <span class="text-blue-800 font-medium" id="selected-count">DeÄŸiÅŸtirilen gÃ¼n: 0</span>
                </div>
            </div>
            
            <!-- Filtre SeÃ§enekleri -->
            <div class="flex flex-wrap items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" id="hideWeekends" onchange="applyFilters()" class="rounded">
                    ğŸ–ï¸ Hafta sonlarÄ±nÄ± gizle
                </label>
                <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" id="hideEmptyDays" onchange="applyFilters()" class="rounded">
                    ğŸ“‹ MenÃ¼ olmayan gÃ¼nleri gizle
                </label>
                <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" id="hidePastDays" onchange="applyFilters()" class="rounded">
                    ğŸ“… GeÃ§miÅŸ gÃ¼nleri gizle
                </label>
            </div>
            
            <div class="flex items-center justify-center space-x-4 mb-6">
                <button onclick="navigateDate(-1)" class="p-2 rounded-lg bg-white hover:bg-gray-100 shadow">â† Ã–nceki</button>
                <span class="text-lg font-semibold text-gray-800" id="current-period"></span>
                <button onclick="navigateDate(1)" class="p-2 rounded-lg bg-white hover:bg-gray-100 shadow">Sonraki â†’</button>
            </div>
            <div class="mb-8" id="menu-container"></div>
            <div class="text-center mt-8 mb-12">
                <button onclick="saveAttendanceSelections()" id="save-btn" class="bg-gray-300 text-gray-500 cursor-not-allowed px-8 py-3 rounded-lg font-semibold shadow-lg" disabled>SeÃ§imlerimi Kaydet (0 gÃ¼n)</button>
            </div>
        </div>

        <div id="mesai-page" class="page-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Fazla Mesai Talepleri</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Yeni Talep OluÅŸtur</h3>
                        <form id="overtimeForm" class="space-y-4">
                            <div>
                                <label for="department" class="block text-sm font-medium text-gray-700">Departman</label>
                                <input type="text" id="department" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ã–rn: YazÄ±lÄ±m GeliÅŸtirme">
                            </div>
                            <div>
                                <label for="overtimeDate" class="block text-sm font-medium text-gray-700">Tarih</label>
                                <input type="date" id="overtimeDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="startTime" class="block text-sm font-medium text-gray-700">BaÅŸlangÄ±Ã§ Saati</label>
                                    <input type="time" id="startTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="endTime" class="block text-sm font-medium text-gray-700">BitiÅŸ Saati</label>
                                    <input type="time" id="endTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="reason" class="block text-sm font-medium text-gray-700">YapÄ±lan Ä°ÅŸin AÃ§Ä±klamasÄ±</label>
                                <textarea id="reason" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                            </div>
                            <div>
                                <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Talep GÃ¶nder
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="md:col-span-2">
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Mevcut Taleplerim</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departman</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saatler</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="overtime-requests-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let currentPage = 'yemekhane';
        let attendanceSelections = {};
        let existingAttendanceData = {}; // Backend'den gelen mevcut veriler
        let activeView = 'daily';
        let currentDate = new Date();
        let currentMenus = []; 

        document.addEventListener('DOMContentLoaded', () => {
            loadFilterPreferences(); // Filtreleri yÃ¼kle
            checkAuth();
            showPage(currentPage);
            document.getElementById('overtimeForm')?.addEventListener('submit', handleOvertimeSubmit);
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (!token) { window.location.href = 'index.html'; return; }
            document.getElementById('userName').textContent = username || 'KullanÄ±cÄ±';
            
            // Departman bilgisini localStorage'dan alÄ±p forma yerleÅŸtir.
            const department = localStorage.getItem('department');
            if (department && document.getElementById('department')) {
                const depInput = document.getElementById('department');
                depInput.value = department;
                depInput.readOnly = true; // KullanÄ±cÄ±nÄ±n deÄŸiÅŸtirmesini engelle
                depInput.style.backgroundColor = '#f3f4f6'; // GÃ¶rsel olarak pasif gÃ¶ster
            }
        }

        function showPage(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageName}-page`).classList.add('active');
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${pageName}-tab`).classList.add('active');

            if (pageName === 'mesai') {
                loadMyOvertimeRequests();
            } else if (pageName === 'yemekhane') {
                setActiveView('daily');
            }
        }

        function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        async function loadMyOvertimeRequests() {
            const token = localStorage.getItem('token');
            const tableBody = document.getElementById('overtime-requests-table');
            try {
                const response = await fetch(`${API_URL}/api/overtime/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Talepler yÃ¼klenemedi');
                const requests = await response.json();
                
                tableBody.innerHTML = requests.map(req => {
                    let statusClass = '';
                    switch (req.status) {
                        case 'OnaylandÄ±':
                            statusClass = 'bg-green-100 text-green-800';
                            break;
                        case 'Departman YÃ¶neticisi TarafÄ±ndan Reddedildi':
                        case 'Reddedildi':
                            statusClass = 'bg-red-100 text-red-800';
                            break;
                        case 'Ä°K OnayÄ± Bekliyor':
                            statusClass = 'bg-blue-100 text-blue-800';
                            break;
                        case 'YÃ¶netici OnayÄ± Bekliyor':
                        default:
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            break;
                    }

                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.department}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(req.date).toLocaleDateString('tr-TR')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.start_time.substring(0,5)} - ${req.end_time.substring(0,5)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${req.status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4" class="text-center py-4">HiÃ§ talebiniz bulunmuyor.</td></tr>';

            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        // DiÄŸer Javascript fonksiyonlarÄ± (yemekhane menÃ¼sÃ¼ ile ilgili) aynÄ± kalabilir.
        // handleOvertimeSubmit, setActiveView, loadMenuData etc.
        function formatDate(date) { 
            // Zaman dilimi sorununu Ã¶nlemek iÃ§in yerel tarih kullan
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getPeriod(view, date) {
            let startDate = new Date(date);
            if (view === 'daily') {
                return { start: startDate, end: startDate };
            }
            if (view === 'weekly') {
                const day = startDate.getDay();
                const diff = startDate.getDate() - day + (day === 0 ? -6 : 1); 
                const start = new Date(startDate.setDate(diff));
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                return { start, end };
            }
            if (view === 'monthly') {
                const start = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                const end = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                return { start, end };
            }
        }

        function setActiveView(view) {
            activeView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + '-btn').classList.add('active');
            loadMenuData();
        }

        function navigateDate(direction) {
            if (activeView === 'daily') currentDate.setDate(currentDate.getDate() + direction);
            else if (activeView === 'weekly') currentDate.setDate(currentDate.getDate() + (direction * 7));
            else if (activeView === 'monthly') currentDate.setMonth(currentDate.getMonth() + direction, 1);
            loadMenuData();
        }

        async function loadMenuData() {
            const container = document.getElementById('menu-container');
            container.innerHTML = '<p class="text-center text-gray-500">MenÃ¼ler yÃ¼kleniyor...</p>';
            
            const period = getPeriod(activeView, new Date(currentDate));
            updatePeriodTitle(period);

            try {
                const token = localStorage.getItem('token');
                
                // MenÃ¼leri Ã§ek
                const menuResponse = await fetch(`${API_URL}/api/menus?start_date=${formatDate(period.start)}&end_date=${formatDate(period.end)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!menuResponse.ok) throw new Error('MenÃ¼ verileri alÄ±namadÄ±');
                currentMenus = await menuResponse.json();
                
                // Mevcut katÄ±lÄ±m durumlarÄ±nÄ± Ã§ek
                const attendanceResponse = await fetch(`${API_URL}/api/attendance?start_date=${formatDate(period.start)}&end_date=${formatDate(period.end)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let existingAttendance = {};
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    // Mevcut katÄ±lÄ±m verilerini attendanceSelections'a ekle
                    attendanceData.forEach(item => {
                        existingAttendance[item.date] = item.will_attend;
                    });
                    // Global deÄŸiÅŸkene de kaydet
                    existingAttendanceData = { ...existingAttendance };
                }
                
                // Mevcut verileri attendanceSelections ile birleÅŸtir (kullanÄ±cÄ±nÄ±n yeni seÃ§imleri Ã¶ncelikli)
                const combinedSelections = { ...existingAttendance, ...attendanceSelections };
                
                renderMenuCards(period, currentMenus, combinedSelections);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            }
        }

        function renderMenuCards(period, menus, currentSelections = {}) {
            console.log('renderMenuCards Ã§aÄŸrÄ±ldÄ±:', { period, menusCount: menus.length }); // Debug
            
            const container = document.getElementById('menu-container');
            const menuMap = new Map(menus.map(m => [m.date, m]));
            
            // Filtre ayarlarÄ±nÄ± oku
            const hideWeekends = document.getElementById('hideWeekends').checked;
            const hideEmptyDays = document.getElementById('hideEmptyDays').checked;
            const hidePastDays = document.getElementById('hidePastDays').checked;
            
            console.log('Render sÄ±rasÄ±nda filtre durumlarÄ±:', { hideWeekends, hideEmptyDays, hidePastDays }); // Debug
            
            let html = '';
            let loopDate = new Date(period.start.getTime());
            let visibleDayCount = 0;

            while (loopDate <= period.end) {
                const dateStr = formatDate(loopDate);
                const menuData = menuMap.get(dateStr);
                
                // Mevcut seÃ§imleri ve kullanÄ±cÄ±nÄ±n yeni seÃ§imlerini birleÅŸtir
                const isSelected = attendanceSelections[dateStr] !== undefined ? attendanceSelections[dateStr] : currentSelections[dateStr];
                const isToday = dateStr === formatDate(new Date());
                const isPast = new Date(dateStr) < new Date(new Date().setHours(0, 0, 0, 0));
                const isWeekend = loopDate.getDay() === 0 || loopDate.getDay() === 6;
                const hasMenu = menuData && (menuData.menu_items?.Corbasi || menuData.menu_items?.Ana_Yemek || menuData.menu_items?.Yan_Yemek || menuData.menu_items?.Tatli);
                
                // Filtreleme kontrolÃ¼
                let shouldShow = true;
                if (hideWeekends && isWeekend) shouldShow = false;
                if (hideEmptyDays && !hasMenu) shouldShow = false;
                if (hidePastDays && isPast && !isToday) shouldShow = false;
                
                if (!shouldShow) {
                    // Tarih gÃ¼ncelleme: yeni Date objesi oluÅŸturarak tarih kaymasÄ±nÄ± Ã¶nle
                    const nextDate = new Date(loopDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    loopDate = nextDate;
                    continue;
                }
                
                visibleDayCount++;

                let cardClass = 'bg-white rounded-lg p-4 shadow-md border-2 transition-all flex flex-col';
                if (isSelected === true) cardClass += ' selected-yes';
                else if (isSelected === false) cardClass += ' selected-no';
                else cardClass += ' border-transparent';
                if (isToday) cardClass += ' today-highlight';
                if (isWeekend) cardClass += ' bg-gray-50';

                html += `<div class="${cardClass}" style="min-height: 200px;">`;
                html += `<h3 class="font-semibold mb-3 text-gray-800 text-center border-b pb-2">${loopDate.toLocaleDateString('tr-TR', { weekday: 'long', day: '2-digit', month: 'long' })}</h3>`;
                
                // Mevcut katÄ±lÄ±m durumu gÃ¶stergesi ekle
                if (isSelected !== undefined && currentSelections[dateStr] !== undefined && attendanceSelections[dateStr] === undefined) {
                    const statusText = isSelected ? 'KatÄ±lacak' : 'KatÄ±lmayacak';
                    const statusColor = isSelected ? 'text-green-600' : 'text-red-600';
                    const statusIcon = isSelected ? 'âœ“' : 'âœ—';
                    html += `<div class="mb-2 text-center">
                                <span class="text-xs ${statusColor} font-semibold bg-gray-100 px-2 py-1 rounded-full">
                                    ${statusIcon} Ã–nceki SeÃ§im: ${statusText}
                                </span>
                            </div>`;
                }
                
                if (hasMenu) {
                    html += `<ul class="space-y-2 text-sm text-gray-600 flex-grow">
                                <li class="flex"><span class="font-medium text-gray-700 w-16 flex-shrink-0">Ã‡orba:</span> <span class="flex-1">${menuData.menu_items.Corbasi || '-'}</span></li>
                                <li class="flex"><span class="font-medium text-gray-700 w-16 flex-shrink-0">Ana Y:</span> <span class="flex-1">${menuData.menu_items.Ana_Yemek || '-'}</span></li>
                                <li class="flex"><span class="font-medium text-gray-700 w-16 flex-shrink-0">Yan Y:</span> <span class="flex-1">${menuData.menu_items.Yan_Yemek || '-'}</span></li>
                                <li class="flex"><span class="font-medium text-gray-700 w-16 flex-shrink-0">TatlÄ±:</span> <span class="flex-1">${menuData.menu_items.Tatli || '-'}</span></li>
                            </ul>`;
                } else {
                    html += `<div class="flex-grow flex items-center justify-center text-gray-400 text-sm">MenÃ¼ BelirtilmemiÅŸ</div>`;
                }

                // ButonlarÄ± sadece geÃ§miÅŸ olmayan, menÃ¼ olan ve hafta iÃ§i gÃ¼nlerde gÃ¶ster
                if (!isPast && hasMenu && !isWeekend) {
                    html += `<div class="pt-3 mt-auto border-t">
                                <div class="flex space-x-2">
                                    <button onclick="handleAttendanceChange('${dateStr}', true)" class="flex-1 text-sm py-2 px-3 rounded-lg font-semibold transition-colors ${isSelected === true ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-500 hover:text-white'}">
                                        ${isSelected === true ? 'âœ“ ' : ''}Evet
                                    </button>
                                    <button onclick="handleAttendanceChange('${dateStr}', false)" class="flex-1 text-sm py-2 px-3 rounded-lg font-semibold transition-colors ${isSelected === false ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white'}">
                                        ${isSelected === false ? 'âœ— ' : ''}HayÄ±r
                                    </button>
                                </div>
                            </div>`;
                } else if (isPast && isSelected !== undefined) {
                    // GeÃ§miÅŸ gÃ¼nler iÃ§in sadece seÃ§imi gÃ¶ster
                    const statusText = isSelected ? 'KatÄ±ldÄ±nÄ±z' : 'KatÄ±lmadÄ±nÄ±z';
                    const statusColor = isSelected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const statusIcon = isSelected ? 'âœ“' : 'âœ—';
                    html += `<div class="pt-3 mt-auto border-t text-center">
                                <span class="text-sm font-semibold px-3 py-2 rounded-lg ${statusColor}">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>`;
                }
                html += `</div>`;
                
                // Tarih gÃ¼ncelleme: yeni Date objesi oluÅŸturarak tarih kaymasÄ±nÄ± Ã¶nle
                const nextDate = new Date(loopDate);
                nextDate.setDate(nextDate.getDate() + 1);
                loopDate = nextDate;
            }
            
            // HiÃ§ gÃ¶rÃ¼nÃ¼r gÃ¼n yoksa mesaj gÃ¶ster
            if (visibleDayCount === 0) {
                html = '<div class="text-center text-gray-500 py-8"><p class="text-lg">SeÃ§ilen filtrelere uygun gÃ¼n bulunamadÄ±.</p><p class="text-sm mt-2">Filtre ayarlarÄ±nÄ± deÄŸiÅŸtirmeyi deneyin.</p></div>';
            }
            
            // Grid sÄ±nÄ±fÄ±nÄ± gÃ¶rÃ¼nÃ¼me gÃ¶re ayarla - tÃ¼m gÃ¶rÃ¼nÃ¼mlerde tutarlÄ± boyut
            let gridClass;
            if (activeView === 'daily') {
                gridClass = 'grid grid-cols-1 max-w-lg mx-auto gap-6';
            } else if (activeView === 'weekly') {
                gridClass = 'grid grid-cols-1 md:grid-cols-7 gap-4';
            } else {
                gridClass = 'grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4';
            }
            container.className = gridClass;
            container.innerHTML = html;
            
            console.log('Render tamamlandÄ±. GÃ¶rÃ¼nÃ¼r gÃ¼n sayÄ±sÄ±:', visibleDayCount); // Debug
        }

        function handleAttendanceChange(dateStr, willAttend) {
            attendanceSelections[dateStr] = willAttend;
            updateSelectionCount();
            const period = getPeriod(activeView, new Date(currentDate));
            loadMenuData(); // Mevcut seÃ§imleri de yeniden yÃ¼kle
        }

        function updateSelectionCount() {
            const count = Object.keys(attendanceSelections).length;
            const saveBtn = document.getElementById('save-btn');
            document.getElementById('selected-count').textContent = `DeÄŸiÅŸtirilen gÃ¼n: ${count}`;
            if (count > 0) {
                saveBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg transition-colors';
                saveBtn.disabled = false;
                saveBtn.textContent = `SeÃ§imleri Kaydet (${count} gÃ¼n)`;
            } else {
                saveBtn.className = 'bg-gray-300 text-gray-500 cursor-not-allowed px-8 py-3 rounded-lg font-semibold shadow-lg';
                saveBtn.disabled = true;
                saveBtn.textContent = 'SeÃ§imlerimi Kaydet (0 gÃ¼n)';
            }
        }
        
        function updatePeriodTitle(period) {
            const periodElement = document.getElementById('current-period');
            if (activeView === 'monthly') {
                periodElement.textContent = period.start.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
            } else if (activeView === 'weekly') {
                periodElement.textContent = `${period.start.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })} - ${period.end.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' })}`;
            } else {
                periodElement.textContent = period.start.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        // Filtre deÄŸiÅŸikliÄŸi fonksiyonu
        function applyFilters() {
            console.log('applyFilters Ã§aÄŸrÄ±ldÄ±'); // Debug
            
            // Filtrelerin localStorage'a kaydedilmesi (kullanÄ±cÄ± tercihi)
            const hideWeekends = document.getElementById('hideWeekends').checked;
            const hideEmptyDays = document.getElementById('hideEmptyDays').checked;
            const hidePastDays = document.getElementById('hidePastDays').checked;
            
            console.log('Filtre durumlarÄ±:', { hideWeekends, hideEmptyDays, hidePastDays }); // Debug
            
            localStorage.setItem('menuFilters', JSON.stringify({
                hideWeekends,
                hideEmptyDays,
                hidePastDays
            }));
            
            // Mevcut verilerle yeniden render et - attendance seÃ§imlerini de dahil et
            if (currentMenus && currentMenus.length > 0) {
                console.log('Mevcut menÃ¼lerle render ediliyor:', currentMenus.length); // Debug
                const period = getPeriod(activeView, new Date(currentDate));
                
                // Backend verilerini ve kullanÄ±cÄ± seÃ§imlerini birleÅŸtir (kullanÄ±cÄ± seÃ§imleri Ã¶ncelikli)
                const combinedSelections = { ...existingAttendanceData, ...attendanceSelections };
                renderMenuCards(period, currentMenus, combinedSelections);
            } else {
                console.log('MenÃ¼ verisi yok, yeniden yÃ¼kleniyor'); // Debug
                // EÄŸer mevcut menÃ¼ verisi yoksa yeniden yÃ¼kle
                loadMenuData();
            }
        }

        // Sayfa yÃ¼klendiÄŸinde filtreleri geri yÃ¼kle
        function loadFilterPreferences() {
            const savedFilters = localStorage.getItem('menuFilters');
            if (savedFilters) {
                const filters = JSON.parse(savedFilters);
                document.getElementById('hideWeekends').checked = filters.hideWeekends || false;
                document.getElementById('hideEmptyDays').checked = filters.hideEmptyDays || false;
                document.getElementById('hidePastDays').checked = filters.hidePastDays || false;
            }
        }

        async function saveAttendanceSelections() {
            const token = localStorage.getItem('token');
            const selections = Object.entries(attendanceSelections).map(([date, will_attend]) => ({ date, will_attend }));
            if (selections.length === 0) return;
            try {
                const response = await fetch(`${API_URL}/attendance/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify(selections)
                });
                if (!response.ok) throw new Error('KayÄ±t baÅŸarÄ±sÄ±z');
                alert(`${selections.length} gÃ¼n iÃ§in seÃ§imleriniz kaydedildi!`);
                attendanceSelections = {};
                updateSelectionCount();
            } catch (error) {
                alert("Bir hata oluÅŸtu: " + error.message);
            }
        }

        async function handleOvertimeSubmit(event) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                department: document.getElementById('department').value,
                date: document.getElementById('overtimeDate').value,
                start_time: document.getElementById('startTime').value,
                end_time: document.getElementById('endTime').value,
                reason: document.getElementById('reason').value,
            };
            try {
                const response = await fetch(`${API_URL}/api/overtime`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Talep oluÅŸturulamadÄ±');
                }
                alert('Fazla mesai talebiniz baÅŸarÄ±yla gÃ¶nderildi!');
                document.getElementById('overtimeForm').reset();
                checkAuth(); // Departman bilgisini tekrar doldurmak iÃ§in
                loadMyOvertimeRequests();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
    </script>
</body>
</html>
